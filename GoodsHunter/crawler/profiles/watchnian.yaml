id: watchnian_supd_list_v1
version: 1
site: watchnian.com
category: watch
owner: user
description: >
  Watchnian supd collection list page.
  Extract watch brand, model name, model number(ref), sale price(JPY, tax-in), image url, and product url from listing cards.

match:
  url_regex: "^https://watchnian\\.com/shop/r/rwatch_supd/.*$"
  example_url: https://watchnian.com/shop/r/rwatch_supd/?filtercode13=1#block_of_filter
  priority: 20

fetch:
  engine: playwright
  goto:
    wait_until: networkidle
    timeout_ms: 45000
  wait_for:
    # 等待商品列表加载
    - selector: "div.block-genre-goods-list-container ul li"
      state: attached
      timeout_ms: 5000  # 5秒超时
    # 等待价格元素加载（确保价格数据已渲染）
    - selector: "div.block-genre-goods-list-container ul li div.block-thumbnail-t--price-infos"
      state: visible
      timeout_ms: 1500  # 1.5秒超时，价格可能动态加载需要更长时间
  viewport:
    width: 1280
    height: 720

parse:
  type: list
  # 商品列表容器
  item_selector_candidates:
    - "div.block-genre-goods-list-container ul > li"
  item_selector_pick: first_non_empty

  fields:
    product_url:
      selector: "dl > a"
      attr: "href"
      transforms:
        - type: url_join
          base: "https://watchnian.com"
        - type: strip

    item_id:
      # 从商品URL中提取最后一个路径段作为item_id
      # 例如：https://watchnian.com/shop/g/gik-00-0707255/ -> gik-00-0707255
      selector: "dl > a"
      attr: "href"
      transforms:
        - type: url_join
          base: "https://watchnian.com"
        - type: strip
        # 提取最后一个路径段（去掉查询参数、锚点和末尾斜杠）
        - type: regex_capture
          pattern: "/([^/?#]+)/?$"
          group: 1
        - type: strip

    image:
      # 商品图片
      selector_candidates:
        - "dl > a > dt > figure > img"
        - "dl > a img"
        - "img"
      attr_candidates: ["src", "data-src", "data-original", "data-lazy-src", "srcset", "data-srcset"]
      transforms:
        # 若是 srcset / data-srcset，取最大图
        - type: pick_best_srcset
        - type: strip
        # 如果是相对路径，添加 https://watchnian.com/ 前缀
        - type: url_join
          base: "https://watchnian.com"

    brand_name_model_name_model_no:
      # 从商品标题拆出 品牌/型号名/型号编号
      selector: "dl > a > dd > div.block-thumbnail-t--goods-name > p"
      text: true
      transforms:
        - type: strip
        - type: split_watch_title
    
    price_jpy:
      # 提取价格（税込）
      # 支持两种价格格式：
      # 1. div.block-thumbnail-t--price-infos > div > div > span.num（没有block-thumbnail-t--price类）
      # 2. div.block-thumbnail-t--price-infos > div > div.block-thumbnail-t--price.price.price-default > span.num（有block-thumbnail-t--price类）
      selector_candidates:
        # 第一种格式：直接查找 span.num
        - "dl > a > dd > div.block-thumbnail-t--price-infos > div > div > span.num"
        # 第二种格式：有 block-thumbnail-t--price 类的格式
        - "dl > a > dd > div.block-thumbnail-t--price-infos > div > div.block-thumbnail-t--price.price.price-default > span.num"
        # 回退：如果没有 span.num，尝试直接获取价格容器的文本
        - "dl > a > dd > div.block-thumbnail-t--price-infos > div > div.block-thumbnail-t--price.price.price-default"
      text: true
      transforms:
        # 匹配价格格式：支持两种情况
        # 1. span.num 只包含数字：1,464,100
        # 2. 价格容器包含 ¥ 符号：¥ 1,848,000
        # 使用可选匹配：¥ 符号是可选的
        - type: regex_capture
          pattern: "(?:¥\\s*)?([0-9,]+)"
          group: 1
        - type: replace
          from: ","
          to: ""
        - type: to_int

  # 后处理步骤：在提取字段后执行
  post_list_process:
    - method: deduplicate_by_url
      config:
        url_field: product_url

pagination:
  # 翻页链接
  next_page:
    selector_candidates:
      - "a:has-text('次')"
      - "a:has-text('Next')"
      - "a[rel='next']"
    attr: "href"
    transforms:
      - type: url_join
        base: "https://watchnian.com"

