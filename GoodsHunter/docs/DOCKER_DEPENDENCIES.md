# Docker ä¾èµ–å…³ç³»è¯´æ˜

## æ¦‚è¿°

Docker æœåŠ¡çš„å¯åŠ¨ä¾èµ–å…³ç³»é“¾å¦‚ä¸‹ï¼š

```
docker-compose.yml 
  â””â”€> services.api.build
      â””â”€> Dockerfile (ä½äº ./services/api/Dockerfile)
          â””â”€> requirements.txt (ä½äº ./services/api/requirements.txt)
```

## è¯¦ç»†è¯´æ˜

### 1. docker-compose.yml

`docker-compose.yml` æ˜¯ Docker Compose çš„ä¸»é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†æ‰€æœ‰æœåŠ¡ã€‚

**API æœåŠ¡é…ç½®ï¼š**

```yaml
api:
  build:
    context: ./services/api      # æ„å»ºä¸Šä¸‹æ–‡ç›®å½•
    dockerfile: Dockerfile       # Dockerfile æ–‡ä»¶åï¼ˆç›¸å¯¹äº contextï¼‰
```

**å…³é”®ç‚¹ï¼š**
- `context: ./services/api` - æŒ‡å®šæ„å»ºä¸Šä¸‹æ–‡ä¸º `./services/api` ç›®å½•
- `dockerfile: Dockerfile` - æŒ‡å®š Dockerfile æ–‡ä»¶ï¼ˆé»˜è®¤åœ¨ context ç›®å½•ä¸‹æŸ¥æ‰¾ï¼‰
- å®é™… Dockerfile è·¯å¾„ï¼š`./services/api/Dockerfile`

### 2. Dockerfile

`./services/api/Dockerfile` å®šä¹‰äº†å¦‚ä½•æ„å»º API æœåŠ¡çš„é•œåƒã€‚

**å…³é”®æ­¥éª¤ï¼š**

```dockerfile
FROM python:3.11-slim          # åŸºç¡€é•œåƒ

WORKDIR /app                    # è®¾ç½®å·¥ä½œç›®å½•

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .         # ä»æ„å»ºä¸Šä¸‹æ–‡å¤åˆ¶ requirements.txt åˆ°å®¹å™¨ /app/

# å®‰è£…ä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt  # åœ¨å®¹å™¨å†…å®‰è£…ä¾èµ–

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .                        # å¤åˆ¶æ„å»ºä¸Šä¸‹æ–‡çš„æ‰€æœ‰æ–‡ä»¶åˆ°å®¹å™¨ /app/

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.main:app", ...]
```

**å…³é”®ç‚¹ï¼š**
- `COPY requirements.txt .` - ä» `./services/api/requirements.txt` å¤åˆ¶åˆ°å®¹å™¨å†…çš„ `/app/requirements.txt`
- `RUN pip install ...` - **åœ¨æ„å»ºé•œåƒæ—¶**å®‰è£…ä¾èµ–åˆ°å®¹å™¨å†…çš„ Python ç¯å¢ƒ
- ä¾èµ–å®‰è£…åœ¨é•œåƒçš„ `/usr/local/lib/python3.11/site-packages/` ä¸­

### 3. requirements.txt

`./services/api/requirements.txt` åŒ…å«æ‰€æœ‰ Python ä¾èµ–åŒ…ã€‚

**å½“å‰ä¾èµ–åˆ—è¡¨ï¼š**

```
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
psycopg2-binary==2.9.9
pydantic==2.5.0
pydantic-settings==2.1.0
python-dotenv==1.0.0
minio==7.2.0
langdetect==1.0.9          # â† è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„åŒ…
pyyaml>=6.0.0
```

## ä¾èµ–å…³ç³»æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ docker-compose.yml                                      â”‚
â”‚                                                         â”‚
â”‚ services:                                               â”‚
â”‚   api:                                                  â”‚
â”‚     build:                                              â”‚
â”‚       context: ./services/api  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚       dockerfile: Dockerfile                   â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ./services/api/Dockerfile                      â”‚        â”‚
â”‚                                                â”‚        â”‚
â”‚ FROM python:3.11-slim                          â”‚        â”‚
â”‚ WORKDIR /app                                   â”‚        â”‚
â”‚ COPY requirements.txt .  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚        â”‚
â”‚ RUN pip install -r requirements.txt    â”‚       â”‚        â”‚
â”‚ COPY . .                               â”‚       â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚       â”‚
                                         â”‚       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ./services/api/requirements.txt         â”‚       â”‚        â”‚
â”‚                                        â”‚       â”‚        â”‚
â”‚ fastapi==0.104.1                       â”‚       â”‚        â”‚
â”‚ uvicorn[standard]==0.24.0              â”‚       â”‚        â”‚
â”‚ ...                                    â”‚       â”‚        â”‚
â”‚ langdetect==1.0.9  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Docker é•œåƒæ„å»ºè¿‡ç¨‹                                      â”‚
â”‚                                                         â”‚
â”‚ 1. è¯»å– Dockerfile                                      â”‚
â”‚ 2. ä»æ„å»ºä¸Šä¸‹æ–‡ (./services/api) å¤åˆ¶ requirements.txt â”‚
â”‚ 3. åœ¨å®¹å™¨å†…è¿è¡Œ: pip install -r requirements.txt       â”‚
â”‚ 4. ä¾èµ–å®‰è£…åˆ°: /usr/local/lib/python3.11/site-packages/â”‚
â”‚ 5. å¤åˆ¶åº”ç”¨ä»£ç åˆ° /app                                  â”‚
â”‚ 6. ç”Ÿæˆæœ€ç»ˆé•œåƒ                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é‡è¦æ³¨æ„äº‹é¡¹

### âš ï¸ Volume æŒ‚è½½çš„å½±å“

åœ¨ `docker-compose.yml` ä¸­ï¼ŒAPI æœåŠ¡é…ç½®äº† volume æŒ‚è½½ï¼š

```yaml
volumes:
  - ./services/api:/app              # æœ¬åœ°ä»£ç è¦†ç›–å®¹å™¨å†…çš„ä»£ç 
  - ./storage:/app/../storage
  - ./i18n:/app/../i18n
```

**è¿™æ„å‘³ç€ï¼š**
- âœ… æœ¬åœ°ä»£ç ä¿®æ”¹ä¼šç«‹å³åæ˜ åˆ°å®¹å™¨ä¸­ï¼ˆå¼€å‘æ—¶å¾ˆæœ‰ç”¨ï¼‰
- âš ï¸ **ä½†æ˜¯ï¼ŒPython åŒ…ä¾èµ–ä¸ä¼šè‡ªåŠ¨æ›´æ–°**
- âš ï¸ å¦‚æœ `requirements.txt` æ›´æ–°äº†ï¼Œéœ€è¦**é‡æ–°æ„å»ºé•œåƒ**æ‰èƒ½å®‰è£…æ–°ä¾èµ–

### ğŸ”„ ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°æ„å»ºé•œåƒï¼Ÿ

1. **ä¾èµ–å®‰è£…åœ¨é•œåƒå±‚ä¸­**ï¼š`pip install` æ˜¯åœ¨**æ„å»ºé•œåƒæ—¶**æ‰§è¡Œçš„ï¼Œä¾èµ–è¢«å†™å…¥é•œåƒçš„åªè¯»å±‚
2. **Volume åªæŒ‚è½½ä»£ç **ï¼šVolume æŒ‚è½½åªè¦†ç›– `/app` ç›®å½•çš„ä»£ç æ–‡ä»¶ï¼Œä¸å½±å“å·²å®‰è£…çš„ Python åŒ…
3. **Python åŒ…è·¯å¾„**ï¼šå·²å®‰è£…çš„åŒ…åœ¨ `/usr/local/lib/python3.11/site-packages/`ï¼Œä¸åœ¨ `/app` ç›®å½•ä¸‹

### ğŸ“ å¦‚ä½•æŸ¥çœ‹ä¾èµ–å…³ç³»

#### 1. æŸ¥çœ‹ requirements.txt ä½ç½®

```bash
# requirements.txt ä½ç½®
./services/api/requirements.txt
```

#### 2. æŸ¥çœ‹ Dockerfile ä½ç½®

```bash
# Dockerfile ä½ç½®ï¼ˆç›¸å¯¹äº docker-compose.ymlï¼‰
./services/api/Dockerfile
```

#### 3. æŸ¥çœ‹å®¹å™¨å†…å·²å®‰è£…çš„åŒ…

```bash
# è¿›å…¥å®¹å™¨
docker compose exec api bash

# æŸ¥çœ‹å·²å®‰è£…çš„åŒ…
pip list

# æˆ–æ£€æŸ¥ç‰¹å®šåŒ…
pip show langdetect
```

#### 4. éªŒè¯ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…

```bash
# åœ¨å®¹å™¨å†…æµ‹è¯•å¯¼å…¥
docker compose exec api python -c "import langdetect; print('langdetect å·²å®‰è£…')"
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä¿®æ”¹äº† requirements.txt ä½†å®¹å™¨å†…è¿˜æ˜¯æ²¡æœ‰æ–°åŒ…ï¼Ÿ

**A:** å› ä¸ºä¾èµ–æ˜¯åœ¨**æ„å»ºé•œåƒæ—¶**å®‰è£…çš„ï¼Œä¸æ˜¯è¿è¡Œæ—¶ã€‚éœ€è¦é‡æ–°æ„å»ºé•œåƒï¼š

```bash
docker compose build --no-cache api
docker compose up -d api
```

### Q: ä¸ºä»€ä¹ˆæœ¬åœ°æœ‰åŒ…ä½†å®¹å™¨å†…æ²¡æœ‰ï¼Ÿ

**A:** å› ä¸ºæœ¬åœ° Python ç¯å¢ƒå’Œå®¹å™¨å†…çš„ Python ç¯å¢ƒæ˜¯**å®Œå…¨åˆ†ç¦»çš„**ï¼š
- æœ¬åœ°ç¯å¢ƒï¼šä½ çš„ç³»ç»Ÿ Python æˆ–è™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚ uvï¼‰
- å®¹å™¨ç¯å¢ƒï¼šDocker é•œåƒå†…çš„ Python ç¯å¢ƒ

### Q: å¦‚ä½•æ·»åŠ æ–°ä¾èµ–ï¼Ÿ

**A:** 
1. ç¼–è¾‘ `./services/api/requirements.txt`ï¼Œæ·»åŠ æ–°åŒ…
2. é‡æ–°æ„å»ºé•œåƒï¼š`docker compose build api`
3. é‡å¯æœåŠ¡ï¼š`docker compose up -d api`

### Q: å¯ä»¥åœ¨è¿è¡Œä¸­çš„å®¹å™¨å†…å®‰è£…åŒ…å—ï¼Ÿ

**A:** å¯ä»¥ï¼Œä½†åªæ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼š

```bash
docker compose exec api pip install æ–°åŒ…å
```

âš ï¸ **æ³¨æ„**ï¼šå®¹å™¨é‡å¯åä¼šä¸¢å¤±ï¼Œå› ä¸ºåŒ…æ²¡æœ‰å†™å…¥é•œåƒå±‚ã€‚

## æ€»ç»“

- **docker-compose.yml** â†’ å®šä¹‰æœåŠ¡é…ç½®å’Œæ„å»ºè·¯å¾„
- **Dockerfile** â†’ å®šä¹‰å¦‚ä½•æ„å»ºé•œåƒï¼ˆåŒ…æ‹¬å®‰è£…ä¾èµ–ï¼‰
- **requirements.txt** â†’ å®šä¹‰ Python ä¾èµ–åˆ—è¡¨
- **æ„å»ºæ—¶** â†’ ä¾èµ–è¢«å®‰è£…åˆ°é•œåƒä¸­
- **è¿è¡Œæ—¶** â†’ Volume æŒ‚è½½åªå½±å“ä»£ç ï¼Œä¸å½±å“å·²å®‰è£…çš„åŒ…

**å…³é”®ç‚¹ï¼šä¿®æ”¹ requirements.txt åå¿…é¡»é‡æ–°æ„å»ºé•œåƒï¼**
